{% extends 'papers/base.html' %}
{% block title %}{{ paper.title|truncatechars:50 }} - arXiv{% endblock %}

{% block content %}

<script>
  window.MathJax = {
    tex: {
      inlineMath: [['$', '$'], ['\\(', '\\)']],
      displayMath: [['$$', '$$'], ['\\[', '\\]']],
    },
  };
</script>
<script type="text/javascript" id="MathJax-script" async
  src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-svg.js">
</script>

<a href="javascript:history.back()" class="back-link">
    ← Back to Search
</a>

<div class="paper-card">
    <h1 class="paper-title">{{ paper.title }}</h1>
    
    <div class="paper-authors">
        <strong>Authors:</strong>
        {% for author_rel in authors %}
            {{ author_rel.author }}{% if not forloop.last %}, {% endif %}
        {% endfor %}
    </div>
    
    <div class="metadata">
        <div class="metadata-item">
            <div class="metadata-label">arXiv ID</div>
            <div><a href="https://arxiv.org/abs/{{ paper.arxiv_id }}" target="_blank">{{ paper.arxiv_id }}</a></div>
        </div>
        
        <div class="metadata-item">
            <div class="metadata-label">Submitted</div>
            <div>{{ paper.created|date:"F j, Y" }}</div>
        </div>
        
        {% if paper.updated %}
        <div class="metadata-item">
            <div class="metadata-label">Last Updated</div>
            <div>{{ paper.updated|date:"F j, Y" }}</div>
        </div>
        {% endif %}
        
        {% if paper.categories %}
        <div class="metadata-item">
            <div class="metadata-label">Categories</div>
            <div class="categories">
                {% for category in paper.categories %}
                    <span class="category-tag">{{ category }}</span>
                {% endfor %}
            </div>
        </div>
        {% endif %}
    </div>
    
    <div class="abstract">
        <h3 style="margin-bottom: 1rem;">Abstract</h3>
        {{ abstract|safe }}
    </div>
    
    {% if user.is_authenticated %}
    <div style="margin-top: 1.5rem;">
        {% if current_tag %}
            <div class="add-tag-dropdown" style="display: inline-block;">
                <div class="add-tag-main">
                    <button onclick="addToCurrentTag({{ paper.id }})">+ Add to {{ current_tag.name }}</button>
                    <button class="dropdown-toggle" onclick="toggleTagDropdown(event, {{ paper.id }})">▼</button>
                </div>
                <div class="tag-dropdown-menu" id="dropdown-{{ paper.id }}">
                    {% for tag in user_tags %}
                    <div class="tag-dropdown-item" onclick="addToTag({{ paper.id }}, {{ tag.id }}, '{{ tag.name|escapejs }}')">
                        {{ tag.name }}
                    </div>
                    {% endfor %}
                    <div class="tag-dropdown-new" onclick="addToNewTag({{ paper.id }})">
                        + Create New Tag
                    </div>
                </div>
            </div>
        {% else %}
            <div class="add-tag-dropdown" style="display: inline-block;">
                <button class="btn" onclick="toggleTagDropdown(event, {{ paper.id }})">
                    + Add to Tag ▼
                </button>
                <div class="tag-dropdown-menu" id="dropdown-{{ paper.id }}">
                    {% for tag in user_tags %}
                    <div class="tag-dropdown-item" onclick="addToTag({{ paper.id }}, {{ tag.id }}, '{{ tag.name|escapejs }}')">
                        {{ tag.name }}
                    </div>
                    {% endfor %}
                    <div class="tag-dropdown-new" onclick="addToNewTag({{ paper.id }})">
                        + Create New Tag
                    </div>
                </div>
            </div>
        {% endif %}
    </div>
    {% endif %}
    
    <div style="margin-top: 2rem;">
        <a href="https://arxiv.org/abs/{{ paper.arxiv_id }}" 
           target="_blank" 
           class="btn btn-secondary"
           style="margin-right: 1rem;">
            View on arXiv ↗
        </a>
        
        {% if has_embedding %}
        <a href="{% url 'papers:search' %}?single_paper={{ paper.id }}{% if current_tag %}&tag={{ current_tag.id }}{% endif %}" 
           class="btn">
            Find Similar Papers
        </a>
        {% else %}
        <button class="btn" disabled style="opacity: 0.5; cursor: not-allowed;">
            No Embedding Available
        </button>
        {% endif %}
    </div>
</div>

{% endblock %}
