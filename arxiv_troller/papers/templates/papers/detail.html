{% extends 'papers/base.html' %}
{% block title %}{{ paper.title|truncatechars:50 }} - arXiv{% endblock %}

{% block body_class %}{% if current_tag %}class="has-drawer"{% endif %}{% endblock %}

{% block header_tags %}
{% if user.is_authenticated and user_tags %}
<div class="header-tags">
    <div class="tag-list">
        <strong>Your Tags:</strong>
        {% for tag in user_tags %}
            <button class="tag-button {% if current_tag and current_tag.id == tag.id %}active{% endif %}"
                    onclick="window.location.href='{% url 'papers:search' %}?tag={{ tag.id }}'">
                {{ tag.name }} ({{ tag.tagged_papers.count }})
            </button>
        {% endfor %}
    </div>
</div>
{% endif %}
{% endblock %}

{% block content %}

<script>
  window.MathJax = {
    tex: {
      inlineMath: [['$', '$'], ['\\(', '\\)']],
      displayMath: [['$$', '$$'], ['\\[', '\\]']],
    },
  };
</script>
<script type="text/javascript" id="MathJax-script" async
  src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-svg.js">
</script>

<style>
.add-tag-dropdown {
    position: relative;
    display: inline-block;
}

.add-tag-main {
    display: flex;
    align-items: center;
}

.add-tag-main button {
    background: #3498db;
    color: white;
    border: none;
    padding: 10px 16px;
    border-radius: 4px 0 0 4px;
    cursor: pointer;
    font-size: 1rem;
}

.add-tag-main .dropdown-toggle {
    background: #2980b9;
    border-radius: 0 4px 4px 0;
    border-left: 1px solid rgba(255,255,255,0.3);
    padding: 10px 12px;
}

.add-tag-main button:hover {
    background: #2980b9;
}

.add-tag-main .dropdown-toggle:hover {
    background: #21618c;
}

.tag-dropdown-menu {
    display: none;
    position: absolute;
    top: 100%;
    left: 0;
    background: white;
    border: 1px solid #ddd;
    border-radius: 4px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.15);
    min-width: 200px;
    z-index: 1000;
    margin-top: 4px;
}

.tag-dropdown-menu.show {
    display: block;
}

.tag-dropdown-item {
    padding: 10px 15px;
    cursor: pointer;
    border-bottom: 1px solid #eee;
}

.tag-dropdown-item:hover {
    background: #f0f8ff;
}

.tag-dropdown-item:last-child {
    border-bottom: none;
}

.tag-dropdown-new {
    padding: 10px 15px;
    border-top: 2px solid #ddd;
    background: #f9f9f9;
    font-weight: 600;
    color: #3498db;
    cursor: pointer;
}

.tag-dropdown-new:hover {
    background: #f0f8ff;
}
</style>

<a href="{% url 'papers:search' %}{% if current_tag %}?tag={{ current_tag.id }}{% endif %}" class="back-link">
    ‚Üê Back to Search
</a>

<!-- Tag drawer (if in tag context) -->
{% if current_tag %}
<div style="position: absolute; left: 0; width: 300px;">
    <div style="position: sticky; top: 0; width: 300px; background: white; box-shadow: 2px 0 8px rgba(0,0,0,0.1); height: 100vh; display: flex; flex-direction: column; z-index: 50;">
        <div style="padding: 15px; border-bottom: 2px solid #eee; background: #f8f9fa; display: flex; justify-content: space-between; align-items: center;">
            <h3 style="margin: 0; font-size: 1.1rem; color: #2c3e50;">{{ current_tag.name }}</h3>
            <button onclick="closeTagContext()" style="background: #e74c3c; color: white; border: none; border-radius: 4px; padding: 4px 8px; cursor: pointer; font-size: 1.2rem; line-height: 1;">√ó</button>
        </div>
        <div style="padding: 10px 15px; border-bottom: 1px solid #eee;">
            <a href="{% url 'papers:search' %}?tag={{ current_tag.id }}&search_all=1" class="btn" style="width: 100%; text-align: center; text-decoration: none; display: block;">
                üîç Search All Papers
            </a>
        </div>
        <div style="flex: 1; overflow-y: auto; padding: 10px;">
            {% for tagged in tagged_papers %}
            <div style="padding: 10px; border-bottom: 1px solid #eee; font-size: 0.9rem;">
                <div style="font-weight: 600; color: #2c3e50; margin-bottom: 4px; font-size: 0.95rem;">
                    <a href="{% url 'papers:detail' tagged.paper.id %}?tag={{ current_tag.id }}" style="color: inherit; text-decoration: none;">
                        {{ tagged.paper.title|truncatechars:60 }}
                    </a>
                </div>
                <div style="color: #999; font-size: 0.85rem; font-family: monospace; margin-bottom: 8px;">
                    <a href="https://arxiv.org/abs/{{ tagged.paper.arxiv_id }}" target="_blank" style="color: inherit; text-decoration: none;">
                        {{ tagged.paper.arxiv_id }}
                    </a>
                </div>
            </div>
            {% empty %}
            <p style="padding: 15px; color: #999; text-align: center;">No papers tagged yet</p>
            {% endfor %}
        </div>
    </div>
</div>

<script>
function closeTagContext() {
    window.location.href = "{% url 'papers:search' %}";
}
</script>
{% endif %}

<div>

<div class="paper-card">
    <h1 class="paper-title">{{ paper.title }}</h1>
    
    <div class="paper-authors">
        <strong>Authors:</strong>
        {% for author_rel in authors %}
            {{ author_rel.author }}{% if not forloop.last %}, {% endif %}
        {% endfor %}
    </div>
    
    <div class="metadata">
        <div class="metadata-item">
            <div class="metadata-label">arXiv ID</div>
            <div><a href="https://arxiv.org/abs/{{ paper.arxiv_id }}" target="_blank">{{ paper.arxiv_id }}</a></div>
        </div>
        
        <div class="metadata-item">
            <div class="metadata-label">Submitted</div>
            <div>{{ paper.created|date:"F j, Y" }}</div>
        </div>
        
        {% if paper.updated %}
        <div class="metadata-item">
            <div class="metadata-label">Last Updated</div>
            <div>{{ paper.updated|date:"F j, Y" }}</div>
        </div>
        {% endif %}
        
        {% if paper.categories %}
        <div class="metadata-item">
            <div class="metadata-label">Categories</div>
            <div class="categories">
                {% for category in paper.categories %}
                    <span class="category-tag">{{ category }}</span>
                {% endfor %}
            </div>
        </div>
        {% endif %}
    </div>
    
    <div class="abstract">
        <h3 style="margin-bottom: 1rem;">Abstract</h3>
        {{ abstract|safe }}
    </div>
    
    {% if user.is_authenticated %}
    <div style="margin-top: 1.5rem;">
        {% if current_tag %}
            <div class="add-tag-dropdown" style="display: inline-block;">
                <div class="add-tag-main">
                    <button onclick="addToCurrentTag({{ paper.id }})">+ Add to {{ current_tag.name }}</button>
                    <button class="dropdown-toggle" onclick="toggleTagDropdown(event)">‚ñº</button>
                </div>
                <div class="tag-dropdown-menu" id="tag-dropdown">
                    {% for tag in user_tags %}
                    <div class="tag-dropdown-item" onclick="addToTag({{ paper.id }}, {{ tag.id }}, '{{ tag.name|escapejs }}')">
                        {{ tag.name }}
                    </div>
                    {% endfor %}
                    <div class="tag-dropdown-new" onclick="addToNewTag({{ paper.id }})">
                        + Create New Tag
                    </div>
                </div>
            </div>
        {% else %}
            <div class="add-tag-dropdown" style="display: inline-block;">
                <button class="btn" onclick="toggleTagDropdown(event)">
                    + Add to Tag ‚ñº
                </button>
                <div class="tag-dropdown-menu" id="tag-dropdown">
                    {% for tag in user_tags %}
                    <div class="tag-dropdown-item" onclick="addToTag({{ paper.id }}, {{ tag.id }}, '{{ tag.name|escapejs }}')">
                        {{ tag.name }}
                    </div>
                    {% endfor %}
                    <div class="tag-dropdown-new" onclick="addToNewTag({{ paper.id }})">
                        + Create New Tag
                    </div>
                </div>
            </div>
        {% endif %}
    </div>
    {% endif %}
    
    <div style="margin-top: 2rem;">
        <a href="https://arxiv.org/abs/{{ paper.arxiv_id }}" 
           target="_blank" 
           class="btn btn-secondary"
           style="margin-right: 1rem;">
            View on arXiv ‚Üó
        </a>
        
        {% if has_embedding %}
        <a href="{% url 'papers:search' %}?single_paper={{ paper.id }}{% if current_tag %}&tag={{ current_tag.id }}{% endif %}" 
           class="btn">
            Find Similar Papers
        </a>
        {% else %}
        <button class="btn" disabled style="opacity: 0.5; cursor: not-allowed;">
            No Embedding Available
        </button>
        {% endif %}
    </div>
</div>

</div>

<script>
const currentTagId = {{ current_tag.id|default:"null" }};

function addToCurrentTag(paperId) {
    fetch("{% url 'papers:add_to_tag' %}", {
        method: 'POST',
        headers: {
            'X-CSRFToken': '{{ csrf_token }}',
            'Content-Type': 'application/x-www-form-urlencoded',
        },
        body: `paper_id=${paperId}&tag_id=${currentTagId}`
    }).then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('Added to tag!');
            const dropdown = document.getElementById('tag-dropdown');
            if (dropdown) dropdown.classList.remove('show');
        }
    });
}

function addToTag(paperId, tagId, tagName) {
    fetch("{% url 'papers:add_to_tag' %}", {
        method: 'POST',
        headers: {
            'X-CSRFToken': '{{ csrf_token }}',
            'Content-Type': 'application/x-www-form-urlencoded',
        },
        body: `paper_id=${paperId}&tag_id=${tagId}`
    }).then(response => response.json())
    .then(data => {
        if (data.success) {
            alert(`Added to ${tagName}!`);
            const dropdown = document.getElementById('tag-dropdown');
            if (dropdown) dropdown.classList.remove('show');
        }
    });
}

function addToNewTag(paperId) {
    const tagName = prompt("Enter new tag name:");
    if (!tagName || !tagName.trim()) return;
    
    fetch("{% url 'papers:add_to_tag' %}", {
        method: 'POST',
        headers: {
            'X-CSRFToken': '{{ csrf_token }}',
            'Content-Type': 'application/x-www-form-urlencoded',
        },
        body: `paper_id=${paperId}&tag_name=${encodeURIComponent(tagName)}`
    }).then(response => response.json())
    .then(data => {
        if (data.success) {
            alert(`Created tag "${data.tag_name}" and added paper!`);
            location.reload();
        }
    });
}

function toggleTagDropdown(event) {
    event.stopPropagation();
    const dropdown = document.getElementById('tag-dropdown');
    dropdown.classList.toggle('show');
}

// Close dropdown when clicking outside
document.addEventListener('click', function(event) {
    if (!event.target.closest('.add-tag-dropdown')) {
        const dropdown = document.getElementById('tag-dropdown');
        if (dropdown) dropdown.classList.remove('show');
    }
});
</script>

{% endblock %}
