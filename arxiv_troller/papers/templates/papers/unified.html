{% extends 'papers/base.html' %}
{% block content %}

<style>
.two-column-layout {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 20px;
    margin-top: 20px;
}
.column {
    background: white;
    padding: 20px;
    border-radius: 8px;
    box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    max-height: 80vh;
    overflow-y: auto;
}
.tag-list {
    display: flex;
    gap: 10px;
    flex-wrap: wrap;
    margin: 20px 0;
}
.tag-button {
    padding: 8px 16px;
    background: #ecf0f1;
    border-radius: 4px;
    text-decoration: none;
    color: #333;
    transition: background 0.3s;
}
.tag-button:hover, .tag-button.active {
    background: #3498db;
    color: white;
}
.action-btn {
    cursor: pointer;
    padding: 4px 8px;
    margin-left: 10px;
    border: none;
    border-radius: 4px;
    font-size: 0.9rem;
}
.add-tag-btn {
    background: #3498db;
    color: white;
}
.remove-btn {
    background: #e74c3c;
    color: white;
}
.paper-item {
    padding: 15px;
    border-bottom: 1px solid #eee;
    transition: background 0.3s;
}
.paper-item:hover {
    background: #f9f9f9;
}
.user-bar {
    display: flex;
    justify-content: space-between;
    align-items: center;
    background: white;
    padding: 10px 20px;
    margin-bottom: 20px;
    border-radius: 8px;
}
</style>

<!-- User bar -->
<div class="user-bar">
    {% if user.is_authenticated %}
        <span>Logged in as: {{ user.username }}</span>
        <a href="{% url 'papers:logout' %}" class="btn btn-secondary">Logout</a>
    {% else %}
        <span>Not logged in</span>
        <a href="{% url 'papers:login' %}" class="btn">Login</a>
    {% endif %}
</div>

<!-- Search bar always visible -->
<div class="search-form">
    <form method="get" action="{% url 'papers:search' %}">
        <input type="text" name="q" value="{{ query }}" 
               placeholder="Search papers by title..." autofocus>
        <button type="submit">Search</button>
    </form>
</div>

<!-- User tags if logged in -->
{% if user.is_authenticated and user_tags %}
<div class="tag-list">
    <strong>Your Tags:</strong>
    {% for tag in user_tags %}
        <a href="{% url 'papers:tag' tag.id %}" 
           class="tag-button {% if current_tag and current_tag.id == tag.id %}active{% endif %}">
            {{ tag.name }} ({{ tag.tagged_papers.count }})
        </a>
    {% endfor %}
</div>
{% endif %}

<!-- Content based on mode -->
{% if mode == 'tag' %}
    <!-- Controls for tag view -->
    <div style="margin: 10px 0; display: flex; gap: 10px; align-items: center;">
        <a href="{% url 'papers:tag_settings' current_tag.id %}" class="btn btn-secondary">
            ‚öôÔ∏è Tag Settings
        </a>
        <form method="get" style="display: flex; gap: 10px; align-items: center;">
            <label>Sort papers:</label>
            <select name="sort" onchange="this.form.submit()">
                <option value="time" {% if sort == 'time' %}selected{% endif %}>By Date Added</option>
                <option value="alpha" {% if sort == 'alpha' %}selected{% endif %}>Alphabetical</option>
            </select>
            
            <label>Date filter:</label>
            <select name="date_filter" onchange="this.form.submit()">
                <option value="1month" {% if date_filter == '1month' %}selected{% endif %}>Last Month</option>
                <option value="3months" {% if date_filter == '3months' %}selected{% endif %}>Last 3 Months</option>
                <option value="6months" {% if date_filter == '6months' %}selected{% endif %}>Last 6 Months</option>
                <option value="1year" {% if date_filter == '1year' %}selected{% endif %}>Last Year</option>
                <option value="all" {% if date_filter == 'all' %}selected{% endif %}>All Time</option>
            </select>
        </form>
        {% if single_paper_id %}
            <a href="{% url 'papers:tag' current_tag.id %}" class="btn btn-secondary">
                ‚Üê Back to All Papers
            </a>
        {% endif %}
    </div>

    <!-- Two column layout for tag view -->
    <div class="two-column-layout">
        <div class="column">
            <h3>Tagged Papers - {{ current_tag.name }}</h3>
            {% for tagged in tagged_papers %}
            <div class="paper-item">
                <div class="paper-title">
                    <a href="{% url 'papers:detail' tagged.paper.id %}">{{ tagged.paper.title }}</a>
                </div>
                <div class="paper-id" style="color: #999; font-size: 0.9rem;">
                    {{ tagged.paper.arxiv_id }}
                </div>
                <button onclick="searchSimilar({{ tagged.paper.id }})" class="action-btn add-tag-btn">
                    üîç Search Similar
                </button>
            </div>
            {% empty %}
            <p>No papers tagged yet.</p>
            {% endfor %}
        </div>
        
        <div class="column">
            <h3>Similar Papers</h3>
            {% for item in page_obj %}
            <div class="paper-item" id="paper-{{ item.paper.id }}">
                <div class="paper-title">{{ item.paper.title }}</div>
                <div class="paper-id" style="color: #999; font-size: 0.9rem;">
                    {{ item.paper.arxiv_id }} | Score: {{ item.similarity_score|floatformat:3 }}
                </div>
                <button onclick="addToCurrentTag({{ item.paper.id }})" class="action-btn add-tag-btn">
                    + Add to Tag
                </button>
                <button onclick="removeFromSearch({{ item.paper.id }}, {{ current_tag.id }})" 
                        class="action-btn remove-btn">
                    √ó Hide
                </button>
            </div>
            {% empty %}
            <p>No similar papers found.</p>
            {% endfor %}
            
            <!-- Pagination -->
            {% if page_obj.has_other_pages %}
            <div style="margin-top: 20px; text-align: center;">
                {% if page_obj.has_previous %}
                    <a href="?page={{ page_obj.previous_page_number }}&date_filter={{ date_filter }}&sort={{ sort }}{% if single_paper_id %}&single_paper={{ single_paper_id }}{% endif %}">‚Üê Previous</a>
                {% endif %}
                Page {{ page_obj.number }} of {{ page_obj.paginator.num_pages }}
                {% if page_obj.has_next %}
                    <a href="?page={{ page_obj.next_page_number }}&date_filter={{ date_filter }}&sort={{ sort }}{% if single_paper_id %}&single_paper={{ single_paper_id }}{% endif %}">Next ‚Üí</a>
                {% endif %}
            </div>
            {% endif %}
        </div>
    </div>

{% elif mode == 'search' and papers %}
    <!-- Regular search results -->
    <h2>Search Results</h2>
    {% for paper in papers %}
    <div class="paper-card">
        <div class="paper-title">
            <a href="{% url 'papers:detail' paper.id %}">{{ paper.title }}</a>
        </div>
        <div class="paper-id">{{ paper.arxiv_id }}</div>
        {% if user.is_authenticated %}
        <button onclick="showAddTagDialog({{ paper.id }})" class="action-btn add-tag-btn">
            + Add to Tag
        </button>
        {% endif %}
    </div>
    {% endfor %}
{% endif %}

<script>
function searchSimilar(paperId) {
    window.location.href = `?single_paper=${paperId}&date_filter={{ date_filter }}&sort={{ sort }}`;
}

function addToCurrentTag(paperId) {
    fetch("{% url 'papers:add_to_tag' %}", {
        method: 'POST',
        headers: {
            'X-CSRFToken': '{{ csrf_token }}',
            'Content-Type': 'application/x-www-form-urlencoded',
        },
        body: `paper_id=${paperId}&tag_id={{ current_tag.id }}`
    }).then(response => response.json())
    .then(data => {
        if (data.success) {
            // Move to left column
            location.reload();
        }
    });
}

function removeFromSearch(paperId, tagId) {
    fetch("{% url 'papers:remove_from_search' %}", {
        method: 'POST',
        headers: {
            'X-CSRFToken': '{{ csrf_token }}',
            'Content-Type': 'application/x-www-form-urlencoded',
        },
        body: `paper_id=${paperId}&tag_id=${tagId}`
    }).then(() => {
        document.getElementById(`paper-${paperId}`).style.display = 'none';
    });
}

function showAddTagDialog(paperId) {
    const tagName = prompt("Enter tag name (or choose from existing tags):");
    if (tagName) {
        fetch("{% url 'papers:add_to_tag' %}", {
            method: 'POST',
            headers: {
                'X-CSRFToken': '{{ csrf_token }}',
                'Content-Type': 'application/x-www-form-urlencoded',
            },
            body: `paper_id=${paperId}&tag_name=${tagName}`
        }).then(() => alert("Added to tag!"));
    }
}
</script>

{% endblock %}
