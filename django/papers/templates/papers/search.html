{% extends 'papers/base.html' %}

{% block content %}

<!-- Search bar always visible -->
<div class="search-form">
  <form method="get" action="{% url 'papers:search' %}" id="search-form">
    <div style="position: relative; display: flex; align-items: center; gap: 0.5rem;">
      <input type="text" name="q" id="search-input" value="{{ query }}" placeholder="Search papers by title..." autofocus style="flex: 1;">
      <button type="button" id="help-toggle" style="padding: 0.625rem; font-size: 1.2rem; background: #e8eaed; border: 1px solid #000000; cursor: pointer; line-height: 1;">?</button>
      <button type="submit">Search</button>
    </div>
  </form>
  
  <!-- Help dropdown -->
  <div id="help-dropdown" style="display: {% if not results %}block{% else %}none{% endif %}; margin-top: 0.5rem; padding: 1rem; border: 1px solid #000000; background: #f8f9fa;">
    <h4 style="margin-top: 0; margin-bottom: 0.75rem;">Search Syntax</h4>
    <div style="line-height: 1.8;">
      <p style="margin-bottom: 0.5rem;"><strong>Keyword search:</strong> Enter any text to search paper titles</p>
      <p style="margin-bottom: 0.5rem; padding-left: 1rem; font-family: monospace; color: #666;">Example: neural networks</p>
      
      <p style="margin-bottom: 0.5rem; margin-top: 1rem;"><strong>Tag search:</strong> Search for papers similar to all papers in a tag</p>
      <p style="margin-bottom: 0.5rem; padding-left: 1rem; font-family: monospace; color: #666;">Format: tag: &lt;tag_name&gt;</p>
      <p style="margin-bottom: 0.5rem; padding-left: 1rem; font-family: monospace; color: #666;">Example: tag: favorites</p>
      
      <p style="margin-bottom: 0.5rem; margin-top: 1rem;"><strong>Similar paper search:</strong> Search for papers similar to a specific paper</p>
      <p style="margin-bottom: 0.5rem; padding-left: 1rem; font-family: monospace; color: #666;">Format: paper: &lt;arxiv_id&gt;</p>
      <p style="margin-bottom: 0; padding-left: 1rem; font-family: monospace; color: #666;">Example: paper: 2301.12345</p>
    </div>
  </div>
</div>

<!-- Error message -->
{% if query_error %}
<div class="paper-card" style="background: #ffe6e6; border-color: #ff0000;">
  <p style="color: #cc0000; font-weight: 600;">{{ query_error }}</p>
</div>
{% endif %}

<!-- Results area -->
<div class="results-area">
  <!-- Search context indicator -->
  {% if search_context %}
  <div class="search-context">
    {% if search_context.type == 'keyword' %}
    <h3>Keyword Search Results</h3>
    <p>Searching for: <strong>"{{ search_context.query }}"</strong></p>
    {% elif search_context.type == 'tag_all' %}
    <h3>Similar Papers - Tag: {{ search_context.tag.name }}</h3>
    <p>Finding papers similar to all papers in this tag</p>
    {% elif search_context.type == 'single_paper' %}
    <h3>Similar Papers</h3>
    <div class="paper-title">{{ search_context.paper.title }}</div>
    <div class="paper-id">arXiv:{{ search_context.paper.arxiv_id }}</div>
    {% endif %}
  </div>
  {% endif %}

  <!-- Filter controls -->
  <div class="filter-controls">
    <form method="get" id="filter-form">
      {% if query %}
      <input type="hidden" name="q" value="{{ query }}">
      {% endif %}
      {% if current_tag %}
      <input type="hidden" name="tag" value="{{ current_tag.id }}">
      {% endif %}
      {% if single_paper_id %}
      <input type="hidden" name="single_paper" value="{{ single_paper_id }}">
      {% endif %}
      {% if search_all_tag %}
      <input type="hidden" name="search_all" value="1">
      {% endif %}

      <div class="filter-group">
        <label>Date Range:</label>
        <div class="add-tag-dropdown" style="display: inline-block; width: 200px;">
          <button type="button" onclick="toggleFilterDropdown(event, 'date-filter')" 
                  style="width: 100%; text-align: left; display: flex; justify-content: space-between; align-items: center; background: #e8eaed; color: #000000; border: 1px solid #000000; padding: 0.5rem 0.75rem; border-radius: 0; cursor: pointer; font-size: 0.875rem; font-family: 'Inter', sans-serif; font-weight: 500;">
            <span id="date-filter-selected">
              {% if date_filter == '1day' %}Last Day
              {% elif date_filter == '3day' %}Last 3 Days
              {% elif date_filter == '1week' %}Last Week
              {% elif date_filter == '1month' %}Last Month
              {% elif date_filter == '3months' %}Last 3 Months
              {% elif date_filter == '6months' %}Last 6 Months
              {% elif date_filter == '1year' %}Last Year
              {% else %}All Time{% endif %}
            </span>
            <span style="font-size: 0.5rem;">▼</span>
          </button>
          <div class="tag-dropdown-menu" id="dropdown-date-filter" style="width: 100%;">
            <div class="tag-dropdown-item" onclick="setFilterValue('date_filter', 'all', 'All Time')">All Time</div>
            <div class="tag-dropdown-item" onclick="setFilterValue('date_filter', '1day', 'Last Day')">Last Day</div>
            <div class="tag-dropdown-item" onclick="setFilterValue('date_filter', '3day', 'Last 3 Days')">Last 3 Days</div>
            <div class="tag-dropdown-item" onclick="setFilterValue('date_filter', '1week', 'Last Week')">Last Week</div>
            <div class="tag-dropdown-item" onclick="setFilterValue('date_filter', '1month', 'Last Month')">Last Month</div>
            <div class="tag-dropdown-item" onclick="setFilterValue('date_filter', '3months', 'Last 3 Months')">Last 3 Months</div>
            <div class="tag-dropdown-item" onclick="setFilterValue('date_filter', '6months', 'Last 6 Months')">Last 6 Months</div>
            <div class="tag-dropdown-item" onclick="setFilterValue('date_filter', '1year', 'Last Year')">Last Year</div>
          </div>
        </div>
      </div>

      <div class="filter-group">
        <label>Category:</label>
        <div class="add-tag-dropdown" style="display: inline-block; width: 200px;">
          <button type="button" onclick="toggleFilterDropdown(event, 'category-filter')" 
                  style="width: 100%; text-align: left; display: flex; justify-content: space-between; align-items: center; background: #e8eaed; color: #000000; border: 1px solid #000000; padding: 0.5rem 0.75rem; border-radius: 0; cursor: pointer; font-size: 0.875rem; font-family: 'Inter', sans-serif; font-weight: 500;">
            <span id="category-filter-selected">
              {% if category_filter %}{{ category_filter }}{% else %}All Categories{% endif %}
            </span>
            <span style="font-size: 0.5rem;">▼</span>
          </button>
          <div class="tag-dropdown-menu" id="dropdown-category-filter" style="width: 100%;">
            <div class="tag-dropdown-item" onclick="setFilterValue('category', '', 'All Categories')">All Categories</div>
            {% for cat in all_categories %}
            <div class="tag-dropdown-item" onclick="setFilterValue('category', '{{ cat }}', '{{ cat }}')">{{ cat }}</div>
            {% endfor %}
          </div>
        </div>
      </div>
    </form>
  </div>

  <!-- Results -->
  <div id="results-container">
    {% if results %}
    {% include 'papers/paper_card.html' with results=results %}

    <!-- Load More Button -->
    {% if has_more %}
    <div id="load-more-container" style="text-align: center; margin: 30px 0;">
      <button id="load-more-btn" class="btn" data-offset="{{ next_offset }}">
        Load More Results
      </button>
    </div>
    {% endif %}
    {% elif query or single_paper_id or search_all_tag %}
    <div class="paper-card">
      <p>No results found. Try a different search or adjust your filters.</p>
    </div>
    {% endif %}
  </div>
</div>

<script>
  // Store current filter values (not yet applied to search)
  let pendingFilters = {
    date_filter: '{{ date_filter }}',
    category: '{{ category_filter }}'
  };

  // Track if user has manually interacted with help dropdown
  let helpManuallyToggled = false;

  // Help dropdown toggle
  document.getElementById('help-toggle').addEventListener('click', function(e) {
    e.preventDefault();
    e.stopPropagation();
    const helpDropdown = document.getElementById('help-dropdown');
    if (helpDropdown.style.display === 'none') {
      helpDropdown.style.display = 'block';
    } else {
      helpDropdown.style.display = 'none';
    }
    helpManuallyToggled = true;
  });

  // Filter dropdown functions
  function toggleFilterDropdown(event, filterId) {
    event.stopPropagation();
    const dropdown = document.getElementById(`dropdown-${filterId}`);
    
    document.querySelectorAll('.tag-dropdown-menu').forEach(d => {
      if (d.id !== `dropdown-${filterId}`) {
        d.classList.remove('show');
      }
    });
    
    dropdown.classList.toggle('show');
  }

  // Update filter value in memory and UI, but don't navigate
  function setFilterValue(paramName, value, displayText) {
    pendingFilters[paramName] = value;
    
    // Update the display
    const displayId = paramName === 'date_filter' ? 'date-filter-selected' : 'category-filter-selected';
    document.getElementById(displayId).textContent = displayText;
    
    // Close dropdown
    document.querySelectorAll('.tag-dropdown-menu').forEach(d => {
      d.classList.remove('show');
    });
  }

  // When search form is submitted, add pending filters to the URL and hide help if appropriate
  document.getElementById('search-form').addEventListener('submit', function(e) {
    // Hide help dropdown on search (will be shown again if no results on next page load)
    document.getElementById('help-dropdown').style.display = 'none';
    
    const form = this;
    const params = new URLSearchParams();
    
    // Add query if present
    const query = document.getElementById('search-input').value;
    if (query) {
      params.set('q', query);
    }
    
    // Preserve tag and sort from current URL if present (to keep drawer state)
    const currentParams = new URLSearchParams(window.location.search);
    const currentTag = currentParams.get('tag');
    const currentSort = currentParams.get('sort');
    console.log('Current URL:', window.location.search);
    console.log('Current tag from URL:', currentTag);
    console.log('Current sort from URL:', currentSort);
    if (currentTag) {
      params.set('tag', currentTag);
      console.log('Setting tag in params:', currentTag);
    }
    if (currentSort) {
      params.set('sort', currentSort);
      console.log('Setting sort in params:', currentSort);
    }
    
    // Add pending filters
    if (pendingFilters.date_filter) {
      params.set('date_filter', pendingFilters.date_filter);
    }
    if (pendingFilters.category) {
      params.set('category', pendingFilters.category);
    }
    
    // Navigate with all parameters
    console.log('Final params:', params.toString());
    console.log('Final URL:', form.action + '?' + params.toString());
    e.preventDefault();
    window.location.href = form.action + '?' + params.toString();
  });

  // Extract abstract drawer logic into reusable function
  function attachAbstractDrawerListeners() {
    document.querySelectorAll('.paper-card').forEach(card => {
      const paperId = card.dataset.paperId;
      const drawer = document.getElementById(`abstract-${paperId}`);

      if (drawer && !card.dataset.listenerAttached) {
        card.addEventListener('click', function (e) {
          if (e.target.closest('a') || e.target.closest('button') ||
            e.target.closest('.abstract-drawer') || e.target.closest('.add-tag-dropdown')) {
            return;
          }
          drawer.classList.toggle('open');
        });
        card.dataset.listenerAttached = 'true';
      }
    });
  }

  // Call on initial page load
  attachAbstractDrawerListeners();

  // Load more functionality
  const loadMoreBtn = document.getElementById('load-more-btn');
  if (loadMoreBtn) {
    let loadedPaperIds = [];
    
    // Collect initially loaded paper IDs
    document.querySelectorAll('.paper-card').forEach(card => {
      loadedPaperIds.push(parseInt(card.dataset.paperId));
    });

    loadMoreBtn.addEventListener('click', function () {
      const params = new URLSearchParams(window.location.search);
      const queryParams = Object.fromEntries(params);

      // Disable button while loading
      this.disabled = true;
      this.textContent = 'Loading...';

      fetch('{% url "papers:search" %}', {
        method: 'POST',
        headers: {
          'X-Requested-With': 'XMLHttpRequest',
          'Content-Type': 'application/json',
          'X-CSRFToken': '{{ csrf_token }}'
        },
        body: JSON.stringify({
          exclude_ids: loadedPaperIds,
          query_params: queryParams
        })
      })
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            // Insert new results before the load more button
            const loadMoreContainer = document.getElementById('load-more-container');
            loadMoreContainer.insertAdjacentHTML('beforebegin', data.html);

            // Collect newly loaded paper IDs
            const tempDiv = document.createElement('div');
            tempDiv.innerHTML = data.html;
            tempDiv.querySelectorAll('.paper-card').forEach(card => {
              loadedPaperIds.push(parseInt(card.dataset.paperId));
            });

            // Attach abstract drawer listeners to new cards
            attachAbstractDrawerListeners();

            if (data.has_more && loadedPaperIds.length < 1000) {
              // Re-enable button
              loadMoreBtn.disabled = false;
              loadMoreBtn.textContent = 'Load More Results';
            } else {
              // Remove button if no more results or hit limit
              loadMoreContainer.remove();
            }
          }
        })
        .catch(error => {
          console.error('Error loading more results:', error);
          loadMoreBtn.disabled = false;
          loadMoreBtn.textContent = 'Load More Results';
        });
    });
  }

  // On page load, check if we should auto-populate search from URL parameter
  document.addEventListener('DOMContentLoaded', function() {
    const urlParams = new URLSearchParams(window.location.search);
    const populateSearch = urlParams.get('populate_search');
    
    if (populateSearch) {
      document.getElementById('search-input').value = populateSearch;
      // Remove the populate_search parameter from URL
      urlParams.delete('populate_search');
      const newUrl = window.location.pathname + (urlParams.toString() ? '?' + urlParams.toString() : '');
      window.history.replaceState({}, '', newUrl);
    }
  });
</script>

{% endblock %}
