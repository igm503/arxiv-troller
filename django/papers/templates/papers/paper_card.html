{% for item in results %}
<div class="paper-card" data-paper-id="{{ item.paper.id }}">
    <div class="paper-title">
        <a href="{% url 'papers:detail' item.paper.id %}{% if current_tag %}?tag={{ current_tag.id }}{% if request.GET.sort %}&sort={{ request.GET.sort }}{% endif %}{% endif %}">{{ item.processed_title|safe }}</a>
    </div>
    
    <div class="paper-authors">
        {% with authors=item.paper.authors.all|slice:":3" %}
            {% for author in authors %}
                {{ author }}{% if not forloop.last %}, {% endif %}
            {% endfor %}
            {% if item.paper.authors.count > 3 %}
                et al.
            {% endif %}
        {% endwith %}
    </div>
    
    <div class="paper-id" style="display: flex; justify-content: space-between; align-items: center;">
        <div>
            <a href="https://arxiv.org/abs/{{ item.paper.arxiv_id }}" target="_blank">
                arXiv:{{ item.paper.arxiv_id }}
            </a>
        </div>
        <div style="display: flex; align-items: center; gap: 10px;">
            {% if item.tags %}
            <span class="tags-container">
                {% for tag_name in item.tags %}
                    <span class="tag-badge" data-tag-name="{{ tag_name }}">
                        {{ tag_name }}
                    </span>
                {% endfor %}
            </span>
            {% endif %}
            {% if user.is_authenticated %}
                {% if current_tag %}
                    <div class="add-tag-dropdown" style="display: inline-block;">
                        <div class="add-tag-main">
                            <button onclick="addToCurrentTag({{ item.paper.id }}, event)" style="padding: 0.625rem 0.75rem;">Add Tag</button>
                            <button class="dropdown-toggle" onclick="toggleTagDropdown(event, {{ item.paper.id }})" style="padding: 0.625rem 0.75rem;">
                                <span style="font-size: 0.5rem;">▼</span>
                            </button>
                        </div>
                        <div class="tag-dropdown-menu" id="dropdown-{{ item.paper.id }}">
                            {% for tag in user_tags %}
                            <div class="tag-dropdown-item" onclick="addToTag({{ item.paper.id }}, {{ tag.id }}, '{{ tag.name|escapejs }}')">
                                {{ tag.name }}
                            </div>
                            {% endfor %}
                            <div class="tag-dropdown-new" onclick="addToNewTag({{ item.paper.id }})">
                                + Create New Tag
                            </div>
                        </div>
                    </div>
                {% else %}
                    <div class="add-tag-dropdown" style="display: inline-block;">
                        <button class="action-btn" onclick="toggleTagDropdown(event, {{ item.paper.id }})" style="padding: 0.625rem 0.75rem;">
                            Add Tag <span style="font-size: 0.5rem; padding-left: 0.75rem;"> ▼</span>
                        </button>
                        <div class="tag-dropdown-menu" id="dropdown-{{ item.paper.id }}">
                            {% for tag in user_tags %}
                            <div class="tag-dropdown-item" onclick="addToTag({{ item.paper.id }}, {{ tag.id }}, '{{ tag.name|escapejs }}')">
                                {{ tag.name }}
                            </div>
                            {% endfor %}
                            <div class="tag-dropdown-new" onclick="addToNewTag({{ item.paper.id }})">
                                + Create New Tag
                            </div>
                        </div>
                    </div>
                {% endif %}
            {% endif %}
        </div>
    </div>
    
    <div class="abstract-drawer" id="abstract-{{ item.paper.id }}">
        <div class="paper-authors" style="margin-bottom: 10px;">
            <strong>Authors:</strong>
            {% for author in item.paper.authors.all %}
                {{ author }}{% if not forloop.last %}, {% endif %}
            {% endfor %}
        </div>
        <div style="margin-bottom: 8px; color: #666; font-size: 0.9rem;">
            <strong>Submitted:</strong> {{ item.paper.created|date:"M Y" }}
            {% if item.paper.updated %}
            | <strong>Updated:</strong> {{ item.paper.updated|date:"M Y" }}
            {% endif %}
        </div>
        <div style="line-height: 1.6;">
            {{ item.processed_abstract|safe }}
        </div>
    </div>
</div>
{% endfor %}
