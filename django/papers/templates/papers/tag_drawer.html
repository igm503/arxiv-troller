<div class="tag-drawer-wrapper" {% if not current_tag %}style="display: none;" {% endif %}>
  <div style="
      display: flex;
      flex-direction: column;
      position: relative;
    ">
    <div style="
        padding: 15px;
        border-bottom: 1px solid #bbbb;
        background: #f8f9fa;
        display: flex;
        justify-content: space-between;
        align-items: center;
        flex-shrink: 0;
        gap: 8px;
      ">
      <h3 id="tag-name-display" style="
          margin: 0;
          font-size: 1.1rem;
          color: #2c3e50;
          overflow-wrap: break-word;
          word-break: break-word;
          min-width: 0;
          flex: 1;
        ">
        {% if current_tag %}{{ current_tag.name }}{% endif %}
      </h3>
      <input type="text" id="tag-name-input" value="{% if current_tag %}{{ current_tag.name }}{% endif %}" style="
          display: none;
          margin: 0;
          font-size: 1.1rem;
          color: #2c3e50;
          min-width: 0;
          flex: 1;
          padding: 0.5rem;
          border: 1px solid #000000;
          background: #e8eaed;
          font-family: 'Inter', sans-serif;
          font-weight: 600;
        ">
      <div style="display: flex; gap: 8px; align-items: center; flex-shrink: 0;">
        <button onclick="toggleEditMode()" class="btn btn-small" id="edit-toggle-btn">
          Edit
        </button>
        <button onclick="closeTagContext()" class="remove-btn btn-small">
          ×
        </button>
      </div>
    </div>
    <div style="padding: 10px 15px; border-bottom: 1px solid #bbbb; flex-shrink: 0;" id="drawer-search-all">
      {% if tagged_papers %}
      <button type="button" class="btn" onclick="populateSearchWithTag()" style="width: 100%">
        Search Similar Papers
      </button>
      {% endif %}
    </div>
    <div style="padding: 10px; padding-bottom: 70px;" id="drawer-papers-list">
      {% for tagged in tagged_papers %}
      <div style="
          padding: 5px;
          border-bottom: 1px solid #cccc;
          font-size: 0.9rem;
          cursor: pointer;
          position: relative;
        " onclick="populateSearchWithPaper('{{ tagged.paper.arxiv_id }}')" class="drawer-paper-card">
        <div style="
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 4px;
            font-size: 0.95rem;
          ">
          <a href="{% url 'papers:detail' tagged.paper.id %}?tag={{ current_tag.id }}{% if request.GET.sort %}&sort={{ request.GET.sort }}{% endif %}" onclick="event.stopPropagation()"
            style="color: inherit; text-decoration: none">
            {{ tagged.processed_title|truncatechars:60 }}
          </a>
        </div>
        <div style="
            color: #999;
            font-size: 0.85rem;
            font-family: monospace;
            margin-bottom: 8px;
          ">
          <a href="https://arxiv.org/abs/{{ tagged.paper.arxiv_id }}" target="_blank" onclick="event.stopPropagation()"
            style="color: inherit; text-decoration: none">
            {{ tagged.paper.arxiv_id }}
          </a>
          <button class="remove-btn btn-small drawer-remove-btn"
            onclick="event.stopPropagation(); removeFromTag({{ tagged.paper.id }})"
            style="display: none; position: absolute; bottom: 20px; right: 8px; padding: 2px 8px; line-height: 1;">
            −
          </button>
        </div>
      </div>
      {% empty %}
      <p style="padding: 15px; color: #999; text-align: center">
        No papers tagged yet
      </p>
      {% endfor %}
    </div>
  </div>
  <div style="
      position: fixed;
      bottom: 0;
      left: 0;
      width: 340px;
      padding: 10px 15px;
      border-top: 1px solid #000000;
      background: #f8f9fa;
      z-index: 10;
    ">
    <button onclick="showDeleteTagButton()" class="remove-btn btn-small" id="delete-tag-btn" style="display: none; width: 100%;">
      Delete Tag
    </button>
    <div id="sort-dropdown-container" style="width: 100%;">
      <div class="add-tag-dropdown" style="display: block; width: 100%;">
        <button type="button" onclick="toggleSortDropdown(event)" 
                style="width: 100%; text-align: left; display: flex; justify-content: space-between; align-items: center; background: #e8eaed; color: #000000; border: 1px solid #000000; padding: 0.5rem 0.75rem; border-radius: 0; cursor: pointer; font-size: 0.875rem; font-family: 'Inter', sans-serif; font-weight: 500;">
          <span id="sort-selected">
            Sort: Added to Tag
          </span>
          <span style="font-size: 0.5rem;">▲</span>
        </button>
        <div class="tag-dropdown-menu" id="dropdown-sort-menu" style="width: 100%; bottom: 100%; top: auto; margin-bottom: 2px; margin-top: 0;">
          <div class="tag-dropdown-item" onclick="setSortOrder('added')">Added to Tag</div>
          <div class="tag-dropdown-item" onclick="setSortOrder('alpha')">Alphabetical</div>
          <div class="tag-dropdown-item" onclick="setSortOrder('submitted')">Submitted Date</div>
          <div class="tag-dropdown-item" onclick="setSortOrder('updated')">Updated Date</div>
        </div>
      </div>
    </div>
  </div>
</div>

<div id="delete-tag-modal" style="
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.5);
    z-index: 2000;
    justify-content: center;
    align-items: center;
  ">
  <div style="
      background: #f5f5f5;
      border: 1px solid #000000;
      padding: 2rem;
      max-width: 400px;
      width: 90%;
    ">
    <h3 style="margin-top: 0; margin-bottom: 1rem; font-size: 1.1rem;">
      Delete Tag?
    </h3>
    <p style="margin-bottom: 1.5rem; color: #333;">
      Are you sure you want to delete "<span id="delete-tag-name"></span>"? This action cannot be undone.
    </p>
    <div style="display: flex; gap: 1rem; justify-content: flex-end;">
      <button onclick="closeDeleteModal()" class="btn btn-secondary">
        Cancel
      </button>
      <button onclick="confirmDeleteTag()" class="remove-btn" style="padding: 0.625rem 1.25rem;">
        Delete Tag
      </button>
    </div>
  </div>
</div>

<script>
// Initialize sort dropdown display based on current URL parameter
document.addEventListener('DOMContentLoaded', function() {
    const params = new URLSearchParams(window.location.search);
    const currentSort = params.get('sort') || 'added';
    const sortSelected = document.getElementById('sort-selected');
    const sortLabels = {
        'added': 'Added to Tag',
        'alpha': 'Alphabetical',
        'submitted': 'Submitted Date',
        'updated': 'Updated Date'
    };
    if (sortSelected) {
        sortSelected.textContent = 'Sort: ' + sortLabels[currentSort];
    }
});

// Function to populate search bar with paper similarity search
function populateSearchWithPaper(arxivId) {
    console.log('populateSearchWithPaper called with:', arxivId);
    const searchInput = document.getElementById('search-input');
    if (searchInput && arxivId) {
        searchInput.value = 'paper: ' + arxivId;
        console.log('Search input populated with:', searchInput.value);
    } else {
        console.error('Could not populate search:', {searchInput, arxivId});
    }
}

// Function to populate search bar with tag similarity search
function populateSearchWithTag() {
    console.log('populateSearchWithTag called');
    const tagName = document.getElementById('tag-name-display');
    const searchInput = document.getElementById('search-input');
    
    if (!tagName) {
        console.error('Could not find tag-name-display element');
        return;
    }
    if (!searchInput) {
        console.error('Could not find search-input element');
        return;
    }
    
    const tagNameText = tagName.textContent.trim();
    console.log('Tag name:', tagNameText);
    
    if (searchInput && tagNameText) {
        searchInput.value = 'tag: ' + tagNameText;
        console.log('Search input populated with:', searchInput.value);
    }
}
</script>
