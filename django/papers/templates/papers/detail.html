{% extends 'papers/base.html' %}
{% block title %}{{ paper.title|truncatechars:50 }} - arXiv{% endblock %}

{% block content %}

<div class="paper-card" data-paper-id="{{ paper.id }}">
    <div style="margin-bottom: 1rem;">
        <a href="#" id="back-to-search" style="color: #2c3e50; text-decoration: none; font-weight: 500;">
            ← Back to Search
        </a>
    </div>
    
    <h1 class="paper-title">{{ paper.title }}</h1>
    
    <div class="paper-authors">
        <strong>Authors:</strong>
        {% for author_rel in authors %}
            {{ author_rel.author }}{% if not forloop.last %}, {% endif %}
        {% endfor %}
    </div>
    
    <div class="metadata">
        <div class="metadata-item">
            <div class="metadata-label">arXiv ID</div>
            <div><a href="https://arxiv.org/abs/{{ paper.arxiv_id }}" target="_blank">{{ paper.arxiv_id }}</a></div>
        </div>
        
        <div class="metadata-item">
            <div class="metadata-label">Submitted</div>
            <div>{{ paper.created|date:"F j, Y" }}</div>
        </div>
        
        {% if paper.updated %}
        <div class="metadata-item">
            <div class="metadata-label">Last Updated</div>
            <div>{{ paper.updated|date:"F j, Y" }}</div>
        </div>
        {% endif %}
        
        {% if paper.categories %}
        <div class="metadata-item">
            <div class="metadata-label">Categories</div>
            <div class="categories">
                {% for category in paper.categories %}
                    <span class="category-tag">{{ category }}</span>
                {% endfor %}
            </div>
        </div>
        {% endif %}
    </div>
    
    <div class="abstract">
        <h3 style="margin-bottom: 1rem;">Abstract</h3>
        {{ abstract|safe }}
    </div>
    
    <div style="margin-top: 2rem; display: flex; justify-content: space-between; align-items: center;">
        <div>
            <a href="https://arxiv.org/abs/{{ paper.arxiv_id }}" 
               target="_blank" 
               class="btn btn-secondary"
               style="margin-right: 1rem;">
                View on arXiv ↗
            </a>
            
            {% if has_embedding %}
            <a href="{% url 'papers:search' %}?q=paper:+{{ paper.arxiv_id }}{% if current_tag %}&tag={{ current_tag.id }}{% endif %}" 
               class="btn">
                Find Similar Papers
            </a>
            {% else %}
            <button class="btn" disabled style="opacity: 0.5; cursor: not-allowed;">
                No Embedding Available
            </button>
            {% endif %}
        </div>
        
        {% if user.is_authenticated %}
        <div style="display: flex; align-items: center; gap: 10px;">
            <span class="tags-container" id="detail-tags-container">
                {% for tag_name in paper_tags %}
                    <span class="tag-badge" data-tag-name="{{ tag_name }}">
                        {{ tag_name }}
                    </span>
                {% endfor %}
            </span>
            
            {% if current_tag %}
                <div class="add-tag-dropdown" style="display: inline-block;">
                    <div class="add-tag-main">
                        <button onclick="addToCurrentTag({{ paper.id }}, event)" style="padding: 0.625rem 0.75rem;">Add Tag</button>
                        <button class="dropdown-toggle" onclick="toggleTagDropdown(event, {{ paper.id }})" style="padding: 0.625rem 0.75rem;">
                            <span style="font-size: 0.5rem;">▼</span>
                        </button>
                    </div>
                    <div class="tag-dropdown-menu" id="dropdown-{{ paper.id }}">
                        {% for tag in user_tags %}
                        <div class="tag-dropdown-item" onclick="addToTag({{ paper.id }}, {{ tag.id }}, '{{ tag.name|escapejs }}')">
                            {{ tag.name }}
                        </div>
                        {% endfor %}
                        <div class="tag-dropdown-new" onclick="addToNewTag({{ paper.id }})">
                            + Create New Tag
                        </div>
                    </div>
                </div>
            {% else %}
                <div class="add-tag-dropdown" style="display: inline-block;">
                    <button class="action-btn" onclick="toggleTagDropdown(event, {{ paper.id }})" style="padding: 0.625rem 0.75rem;">
                        Add Tag <span style="font-size: 0.5rem;">▼</span>
                    </button>
                    <div class="tag-dropdown-menu" id="dropdown-{{ paper.id }}">
                        {% for tag in user_tags %}
                        <div class="tag-dropdown-item" onclick="addToTag({{ paper.id }}, {{ tag.id }}, '{{ tag.name|escapejs }}')">
                            {{ tag.name }}
                        </div>
                        {% endfor %}
                        <div class="tag-dropdown-new" onclick="addToNewTag({{ paper.id }})">
                            + Create New Tag
                        </div>
                    </div>
                </div>
            {% endif %}
        </div>
        {% endif %}
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const backButton = document.getElementById('back-to-search');
    const referrer = document.referrer;
    
    // Add click handler that reads current state at click time
    backButton.addEventListener('click', function(e) {
        e.preventDefault();
        
        // Read current tag context at click time (not page load)
        const currentParams = new URLSearchParams(window.location.search);
        const currentTag = currentParams.get('tag');
        
        // Check if referrer is a search page on our site
        const isSearchReferrer = referrer && 
                                referrer.includes(window.location.origin) && 
                                (referrer.includes('/search') || referrer.includes('/?'));
        
        let targetUrl;
        
        if (isSearchReferrer) {
            // Extract search params from referrer
            try {
                const referrerUrl = new URL(referrer);
                const referrerParams = new URLSearchParams(referrerUrl.search);
                
                // Build new params: use referrer's search params but current tag context
                const backParams = new URLSearchParams();
                
                // Copy search-related params from referrer
                const searchParams = ['q', 'date_filter', 'category', 'sort'];
                searchParams.forEach(param => {
                    const value = referrerParams.get(param);
                    if (value) {
                        backParams.set(param, value);
                    }
                });
                
                // Use current tag context (from detail page URL at click time)
                if (currentTag) {
                    backParams.set('tag', currentTag);
                }
                
                // Build the URL
                const searchUrl = '{% url "papers:search" %}';
                targetUrl = searchUrl + (backParams.toString() ? '?' + backParams.toString() : '');
            } catch (e) {
                console.error('Error parsing referrer:', e);
                // Fallback: go to search with just current tag
                targetUrl = currentTag ? '{% url "papers:search" %}?tag=' + currentTag : '{% url "papers:search" %}';
            }
        } else {
            // No valid search referrer: go to empty search with current tag context
            targetUrl = currentTag ? '{% url "papers:search" %}?tag=' + currentTag : '{% url "papers:search" %}';
        }
        
        // Navigate to the constructed URL
        window.location.href = targetUrl;
    });
});
</script>

{% endblock %}
